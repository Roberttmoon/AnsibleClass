- name: Create public IP address
  azure_rm_publicipaddress:
    resource_group: "{{ group_name }}"
    allocation_method: Static
    name: "{{ pubip }}-{{ vm.name }}"
  register: output_ip_address
- name: Output public IP 
  debug:
    msg: "Public IP is {{ output_ip_address.state.ip_address }}."
- name: Create Network Security Group that allows SSH
  azure_rm_securitygroup:
    resource_group: "{{ group_name }}"
    name: "{{ security_group }}-{{ vm.name }}"
    rules:
      - name: SSH
        protocol: Tcp
        destination_port_range: 22
        access: Allow
        priority: 1001
        direction: Inbound
- name: Create virtual network inteface card
  azure_rm_networkinterface:
    resource_group: "{{ group_name }}"
    name: "{{ nic }}-{{ vm.name }}"
    virtual_network: "{{ vnet }}"
    subnet: "{{ subnet }}"
    public_ip_name: "{{ pubip }}-{{ vm.name }}"
    security_group: "{{ security_group }}"
- name: Create VM
  azure_rm_virtualmachine:
    resource_group: "{{ group_name }}"
    name: "{{ vm }}-{{ vm.name }}"
    vm_size: Standard_DS1_v2
    admin_username: azureops
    ssh_password_enabled: false
    ssh_public_keys:
      - path: /home/azueuser/.ssh/authorized_keys
        key_data: "{{ lookup('file','/var/lib/jenkens/.ssh/azure-training.pub') }}"
    network_interfaces: "{{ nic }}-{{ vm.name }}"
    tags: "{{ vm.tags }}"
    image:
      offer: UbuntuServer
      publisher: Canonical
      sku: '16.04-lst'
      version: latest
